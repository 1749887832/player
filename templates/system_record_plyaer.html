<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>球员数据</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'css/hsycmsAlert.css' %}">
    <link rel="stylesheet" href="{% static 'css/system_record_player.css' %}">
    <script src="{% static 'layui/layui.js' %}" charset="utf-8"></script>
    <script src="{% static 'js/hsycmsAlert.js' %}"></script>
    <script src="{% static 'js/jquery.cookie.js' %}"></script>
</head>
<body>
<form class="layui-form" action="">
    <div class="layui-inline">
        <label class="layui-form-label" style="width: 100px">球员名称</label>
        <div class="layui-input-block">
            <input type="text" name="main_title" id="main_title" lay-verify="title" autocomplete="off"
                   placeholder="请输入名称"
                   class="layui-input" style="width: 300px;margin-left: -10px">
        </div>
    </div>
    <i class="layui-btn layui-btn-primary layui-icon layui-icon-search"
       style="font-size: 24px;margin-top: -5px;margin-left: -9px" id="select"></i>
    <button class="layui-btn layui-btn-primary" style="margin-top: -5px" id="chong">重置</button>
    <br>
    <div class="layui-inline">
        <label class="layui-form-label" style="width: 100px">赛季</label>
        <div class="layui-input-inline">
            <select name="modules" lay-verify="required" lay-search="jiaolian" id="main_player">
                <option value="">请选择赛季</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label" style="width: 100px">球员</label>
        <div class="layui-input-inline">
            <select name="modules" lay-verify="required" lay-search="start_player" id="start_player">
                <option value="">请选择球员</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label" style="width: 100px">球队</label>
        <div class="layui-input-inline">
            <select name="modules" lay-verify="required" lay-search="end_player" id="end_player">
                <option value="">请选择球队</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label" style="width: 100px">日期范围</label>
        <div class="layui-input-inline">
            <input type="text" name="modules" class="layui-input" id="test6" placeholder="请输入时间范围"
                   style="width: 200px">
        </div>
    </div>
</form>
<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button type="button" class="layui-btn" onclick="open_create()">
            录入球员数据
        </button>
    </div>
</script>
<table class="layui-hide" id="test" lay-filter="test"></table>
<div class="hsycms-model-mask" id="mask-confirm"></div>
<div class="hsycms-model hsycms-model-confirm" id="confirm" style="width: 400px;height: 300px">
    <div class="hscysm-model-title" style="height: 40px;background-color: #2e3338;padding: 0">
        <p>选择赛季</p>
        <p class="layui-icon layui-icon-close-fill" id="close"></p>
    </div>
    <div class="open_context">
        <p><span class="layui-icon layui-icon-about"></span>请选择一个赛季</p>
        <div class="layui-form-item" style="width: 360px">
            <form class="layui-form layui-form-pane" action="">
                <select name="saiji" lay-verify="" id="season">
                    <option value="">请选择一个赛季</option>
                </select>
            </form>
        </div>
    </div>
    {#    <div class="hsycms-model-btn">#}
    {#        <button type="button" class="cancel">取消</button>#}
    {#        <button type="button" class="ok">确定</button>#}
    {#    </div>#}
    <div style="display: flex;align-items: center;justify-content: center;">
        <button type="button" class="layui-btn" style="width: 100%;margin-top: 2px" onclick="open_season()">确定</button>
    </div>
</div>
<div class="create_season">
    <div class="context">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>录入球员数据</legend>
        </fieldset>
        <p>赛&nbsp;&nbsp;&nbsp;&nbsp;季：<span id="season_name"></span></p>
        <form class="layui-form" action="" method="post">
            {% csrf_token %}
            <div class="layui-inline">
                <label class="layui-form-label" style="width: 100px">球&nbsp;&nbsp;&nbsp;&nbsp;员</label>
                <div class="layui-input-inline">
                    <select name="player_id" lay-verify="player" lay-filter="player" lay-search="player" id="player">
                        <option value="">请选择球员</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" style="width: 100px">赛&nbsp;&nbsp;&nbsp;&nbsp;程</label>
                <div class="layui-input-inline" style="width: 400px">
                    <select name="schedule_id" lay-verify="schedule" lay-search="schedule" id="schedule" disabled>
                        <option value="">请选择赛程</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">时&nbsp;&nbsp;&nbsp;&nbsp;间</label>
                    <div class="layui-input-inline">
                        <input type="number" name="time" required lay-verify="required" placeholder="请输入上场时间(min)"
                               autocomplete="off" class="layui-input"
                               onblur="if(value<0){value=0}else{value=Math.round(value*100)/100}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">得&nbsp;&nbsp;&nbsp;&nbsp;分</label>
                    <div class="layui-input-inline">
                        <input type="number" name="score" required lay-verify="required" placeholder="请输入球员得分"
                               autocomplete="off" class="layui-input"
                               onblur="if (value<=0){value=0}else{value=Math.floor(value)}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">投&nbsp;&nbsp;&nbsp;&nbsp;篮</label>
                    <div class="layui-input-inline">
                        <input type="text" name="shoot" required lay-verify="required" placeholder="请输入投篮(出手数-命中数)"
                               autocomplete="off" class="layui-input" onblur="if(!clearNumber(value)){value='0-0'}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">三&nbsp;&nbsp;&nbsp;&nbsp;分</label>
                    <div class="layui-input-inline">
                        <input type="text" name="three_points" required lay-verify="required"
                               placeholder="请输入三分(出手数-命中数)"
                               autocomplete="off" class="layui-input" onblur="if(!clearNumber(value)){value='0-0'}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">罚&nbsp;&nbsp;&nbsp;&nbsp;球</label>
                    <div class="layui-input-inline">
                        <input type="text" name="free_throw" required lay-verify="required"
                               placeholder="请输入罚球(出手数-命中数)"
                               autocomplete="off" class="layui-input" onblur="if(!clearNumber(value)){value='0-0'}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">助&nbsp;&nbsp;&nbsp;&nbsp;攻</label>
                    <div class="layui-input-inline">
                        <input type="number" name="assists" required lay-verify="required" placeholder="请输入球员助攻数"
                               autocomplete="off" class="layui-input"
                               onblur="if (value<=0){value=0}else{value=Math.floor(value)}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">前&nbsp;&nbsp;&nbsp;&nbsp;场</label>
                    <div class="layui-input-inline">
                        <input type="text" name="front_court" required lay-verify="required" placeholder="请输入球员前场篮板数"
                               autocomplete="off" class="layui-input"
                               onblur="if (value<=0){value=0}else{value=Math.floor(value)}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">后&nbsp;&nbsp;&nbsp;&nbsp;场</label>
                    <div class="layui-input-inline">
                        <input type="number" name="back_court" required lay-verify="required" placeholder="请输入球员后场篮板数"
                               autocomplete="off" class="layui-input"
                               onblur="if (value<=0){value=0}else{value=Math.floor(value)}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">盖&nbsp;&nbsp;&nbsp;&nbsp;帽</label>
                    <div class="layui-input-inline">
                        <input type="number" name="block_shot" required lay-verify="required" placeholder="请输入球员盖帽数"
                               autocomplete="off" class="layui-input"
                               onblur="if (value<=0){value=0}else{value=Math.floor(value)}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">抢&nbsp;&nbsp;&nbsp;&nbsp;断</label>
                    <div class="layui-input-inline">
                        <input type="number" name="snatch" required lay-verify="required" placeholder="请输入球员抢断数"
                               autocomplete="off" class="layui-input"
                               onblur="if (value<=0){value=0}else{value=Math.floor(value)}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">失&nbsp;&nbsp;&nbsp;&nbsp;误</label>
                    <div class="layui-input-inline">
                        <input type="number" name="error" required lay-verify="required" placeholder="请输入球员失误数"
                               autocomplete="off" class="layui-input"
                               onblur="if (value<=0){value=0}else{value=Math.floor(value)}">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label" style="width: 100px">犯&nbsp;&nbsp;&nbsp;&nbsp;规</label>
                    <div class="layui-input-inline">
                        <input type="number" name="break_rules" required lay-verify="required" placeholder="请输入球员犯规数"
                               autocomplete="off" class="layui-input"
                               onblur="if (value<=0){value=0}else{value=Math.floor(value)}">
                    </div>
                </div>
            </div>
            <div class="layui-form-item anniu">
                <div class="layui-input-block">
                    <p class="layui-btn layui-btn-primary" style="margin-top: 10px">取消</p>
                    <button type="submit" class="layui-btn" lay-submit="" lay-filter="add_player_data">确认</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script>
    {# 这里是正则匹配输入投篮类型的规则 #}

    function clearNumber(obj) {
        var objRegExp = /^[\d]+-[\d]+$/;
        {#console.log(objRegExp.test(obj));#}
        return objRegExp.test(obj);
    }

    var season_id;
    layui.use('form', function () {
        var form = layui.form;
        form.on('submit(add_player_data)', function (data) {
            if (data.field.player_id === '' || data.field.schedule_id === '') {
                layer.msg('球员或赛程不能为空');
                return false;
            } else {
                $.ajax({
                    async: true,
                    url: '/player/add_playerdata/',
                    type: 'post',
                    headers: {"X-CSRFToken": $.cookie("csrftoken")},
                    data: JSON.stringify(data.field),
                    success: function (success) {
                        $('#schedule').attr("disabled", false);
                        {#renderForm();#}
                        return false;
                    },
                    error: function (error) {
                        layer.msg('接口访问失败');
                        return false;
                    }
                })
            }
        });
        form.on('select(player)', function (data) {
            if (data.value === '') {
                document.getElementById('schedule').value = '';
                $('#schedule').attr("disabled", true);
                renderForm()
            } else {
                $('#schedule').attr("disabled", false);
                renderForm();
                $.ajax({
                    async: true,
                    url: '/player/player_schedule/',
                    type: 'post',
                    headers: {"X-CSRFToken": $.cookie("csrftoken")},
                    data: {
                        'season_id': season_id,
                        'player_id': data.value
                    },
                    success: function (date) {
                        $('.b').remove();
                        jsonDate = JSON.stringify(date['data']);
                        $.each(JSON.parse(jsonDate), function (i, item) {
                            var option = "<option class='b' value=" + item.schedule_id + ">" + item.msg + "</option>";
                            $("#schedule").append(option);
                            renderForm();
                            {#form.render();#}
                        });
                    },
                    error: function (error) {
                        layer.msg(JSON.stringify(error['msg']))
                    }
                })
            }
        })
    });

    function open_season() {
        var season = document.getElementById('season').value;
        if (season === '') {
            layer.msg('赛季不能为空')
        } else {
            hsycms.close('confirm');
            $.ajax({
                async: true,
                url: '/player/select_players/',
                headers: {"X-CSRFToken": $.cookie("csrftoken")},
                type: 'post',
                data: {
                    'season_id': season
                },
                success: function (date) {
                    $('.create_season').css('display', 'block');
                    $('#season_name').text(date['data'][0]['season_name']);
                    season_id = date['data'][0]['season_id'];
                    for (var i = 1; i < date['data'].length; i++) {
                        var option = "<option value=" + date['data'][i].player_id + ">" + date['data'][i].player_name + "</option>";
                        $("#player").append(option);
                        renderForm();
                    }
                },
                error: function () {
                    layer.msg('查询赛季失败')
                }
            });
        }
    }

    function renderForm() {
        layui.use('form', function () {
            var form = layui.form;
            form.render();
        });
    }

    $('#close').click(function () {
        hsycms.close('confirm')
    });

    function open_create() {
        $('#season .a').remove();
        $.ajax({
            async: true,
            url: '/player/select_season/',
            type: 'post',
            headers: {"X-CSRFToken": $.cookie("csrftoken")},
            data: [],
            success: function (date) {
                {#console.log(date)#}
                jsonDate = JSON.stringify(date['data']);
                $.each(JSON.parse(jsonDate), function (i, item) {
                    {#console.log(item.name);#}
                    var option = "<option class='a' value=" + item.id + ">" + item.name + "</option>";
                    $("#season").append(option);
                    renderForm();
                });
            },
            error: function (msg) {
                layer.msg('接口报错')
            }
        });
        hsycms.confirm('confirm', '选择赛季',
            function () {
                console.log(document.getElementById('season').value);
            },
            function (res) {
                layer.msg('取消删除')
            },
        );
    }

    layui.use('laydate', function () {
        var laydate = layui.laydate;
        laydate.render({
            elem: '#test6'
            , range: '至'
            , done: function (value) {
                {#get_date(value)#}
            }
        });
    });
    layui.use('table', function () {
        var table = layui.table;

        table.render({
            elem: '#test'
            , url: '/player/record_player/'
            , toolbar: '#toolbarDemo'
            , title: '用户数据表'
            , totalRow: true
            , cols: [[
                {field: 'id', title: 'ID', width: 80, fixed: 'left', unresize: true, sort: true, totalRowText: '合计行'}
                , {field: 'username', title: '用户名', width: 120, edit: 'text'}
                , {field: 'email', title: '邮箱', width: 150, edit: 'text'}
                , {field: 'experience', title: '积分', width: 100, sort: true, totalRow: true}
                , {field: 'sex', title: '性别', width: 80, edit: 'text', sort: true}
                , {field: 'logins', title: '登入次数', width: 100, sort: true, totalRow: true}
                , {field: 'sign', title: '签名'}
                , {field: 'city', title: '城市', width: 100}
                , {field: 'ip', title: 'IP', width: 120}
                , {field: 'joinTime', title: '加入时间', width: 120}
            ]]
            , page: true
            , response: {
                statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
            }
            , parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.message, //解析提示文本
                    "count": res.total, //解析数据长度
                    "data": res.rows.item //解析数据列表
                };
            }
        });
    });
</script>
</body>
</html>