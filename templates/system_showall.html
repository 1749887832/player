<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>我的团队</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/system_showall.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/hsycmsAlert.css' %}">
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}">
    <script src="{% static 'js/AllSchool.js' %}"></script>
    <script src="{% static 'js/three_city.js' %}"></script>
    <script src="{% static 'js/hsycmsAlert.js' %}"></script>
    <script src="{% static 'layui/layui.js' %}"></script>
    <script src="{% static 'js/pcasunzip.js' %}" charset="gb2312"></script>
    <script src="{% static 'js/jQuery-3.5.1-min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.cookie.js' %}"></script>
</head>
<body>
{% include 'system_index.html' %}
<div class="body">
    <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
        <ul class="layui-tab-title">
            <li class="layui-this">全部</li>
            <li>球员</li>
        </ul>
        <div class="layui-tab-content" style="height: 100px;">
            <div class="layui-tab-item layui-show">
                <form class="layui-form" action="" method="post">
                    {% csrf_token %}
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">球员名称</label>
                        <div class="layui-input-block">
                            <input type="text" name="" id="name" lay-verify="title" autocomplete="off"
                                   placeholder="请输入球员名字"
                                   class="layui-input" style="width: 300px;margin-left: -10px">
                        </div>
                    </div>
                    <i class="layui-btn layui-btn-primary layui-icon layui-icon-search"
                       style="font-size: 24px;margin-top: -5px;margin-left: -9px" id="showall_select"></i>
                    <button class="layui-btn layui-btn-primary" style="margin-top: -5px">重置</button>
                    <br>
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">年&nbsp;&nbsp;&nbsp;&nbsp;龄</label>
                        <div class="layui-input-inline">
                            <select name="modules" lay-verify="required" lay-filter="all_team" lay-search="all_team"
                                    id="age">
                                <option value="">请选择年龄</option>
                                <option value="1">0-20</option>
                                <option value="2">20-30</option>
                                <option value="3">30-100</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">性&nbsp;&nbsp;&nbsp;&nbsp;别</label>
                        <div class="layui-input-inline">
                            <select name="modules" lay-verify="required" lay-filter="all_team" lay-search="all_team"
                                    id="sex">
                                <option value="">请选择性别</option>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">角&nbsp;&nbsp;&nbsp;&nbsp;色</label>
                        <div class="layui-input-inline">
                            <select name="modules" lay-verify="required" lay-filter="all_team" lay-search="all_team"
                                    id="role">
                                <option value="">请选择角色</option>
                                <option value="老板">老板</option>
                                <option value="教练">教练</option>
                                <option value="球探">球探</option>
                                <option value="球员">球员</option>
                            </select>
                        </div>
                    </div>
                </form>
                <table class="layui-hide" id="team" lay-filter="team"></table>
                <script type="text/html" id="allDemo">
                    <a class="layui-btn layui-btn-xs" lay-event="details">编辑</a>
                </script>
            </div>
            <div class="layui-tab-item">
                <form class="layui-form" action="" method="post">
                    {% csrf_token %}
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">球员名称</label>
                        <div class="layui-input-block">
                            <input type="text" name="" id="p_name" lay-verify="title" autocomplete="off"
                                   placeholder="请输入球员名字"
                                   class="layui-input" style="width: 300px;margin-left: -10px">
                        </div>
                    </div>
                    <i class="layui-btn layui-btn-primary layui-icon layui-icon-search"
                       style="font-size: 24px;margin-top: -5px;margin-left: -9px" id="player_select"></i>
                    <p class="layui-btn layui-btn-primary" style="margin-top: 3px" id="chong">重置</p>
                    <br>
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">年&nbsp;&nbsp;&nbsp;&nbsp;龄</label>
                        <div class="layui-input-inline">
                            <select name="modules" lay-verify="required" lay-filter="showall_player" lay-search="showall_player"
                                    id="p_age">
                                <option value="">请选择年龄</option>
                                <option value="1">0-20</option>
                                <option value="2">20-30</option>
                                <option value="3">30-100</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">性&nbsp;&nbsp;&nbsp;&nbsp;别</label>
                        <div class="layui-input-inline">
                            <select name="modules" lay-verify="required" lay-filter="showall_player" lay-search="showall_player"
                                    id="p_sex">
                                <option value="">请选择性别</option>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">状&nbsp;&nbsp;&nbsp;&nbsp;态</label>
                        <div class="layui-input-inline">
                            <select name="modules" lay-verify="required" lay-filter="showall_player" lay-search="showall_player"
                                    id="p_status">
                                <option value="">请选择状态</option>
                                <option value="健康">健康</option>
                                <option value="伤病">伤病</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: 100px">位&nbsp;&nbsp;&nbsp;&nbsp;置</label>
                        <div class="layui-input-inline">
                            <select name="modules" lay-verify="required" lay-filter="showall_player" lay-search="showall_player"
                                    id="p_position">
                                <option value="">请选择球员位置</option>
                                <option value="控球后卫">控球后卫</option>
                                <option value="得分后卫">得分后卫</option>
                                <option value="小前锋">小前锋</option>
                                <option value="大前锋">大前锋</option>
                                <option value="中锋">中锋</option>
                            </select>
                        </div>
                    </div>

                </form>
                <table class="layui-hide" id="all_player" lay-filter="all_player"></table>
                <script type="text/html" id="playerDemo">
                    <a class="layui-btn layui-btn-xs" lay-event="details">续约</a>
                    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">解约</a>
                </script>
            </div>
        </div>
    </div>
</div>
<div class="hsycms-model-mask" id="mask-confirm_sx"></div>
<div class="hsycms-model hsycms-model-confirm" id="confirm_sx">
    <div class="hscysm-model-title">系统提示</div>
    <div class="hsycms-model-text"></div>
    <div class="hsycms-model-btn">
        <button type="button" class="cancel">取消</button>
        <button type="button" class="ok">确定</button>
    </div>
</div>
<div class="update_user">
    <div class="context">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>修改信息</legend>
        </fieldset>
        <form action="" method="post">
            {% csrf_token %}
            <div class="layui-upload" style="margin-left: 30px">
                <div class="layui-upload-list">
                    <img class="layui-upload-img" style="height: 100px;width: 100px" id="pic">
                    <p id="demoText"></p>
                </div>
                <input type="button" class="layui-btn" id="test1" value="上传头像">
            </div>
            <label for="" class="add_player_a">
                姓&nbsp;&nbsp;&nbsp;&nbsp;名:
                <input type="text" placeholder="请输入名字" name="username" id="username">
                <span>*姓名不能为空</span>
            </label>
            <label for="" class="add_player_a">
                性&nbsp;&nbsp;&nbsp;&nbsp;别:
                <select name="user_sex" id="user_sex">
                    <option value="男">男</option>
                    <option value="女">女</option>
                </select>
            </label>
            <label for="" class="add_player_a">
                手机号码:
                <input type="text" class="phone" placeholder="请输入手机号" name="phone" id="phone">
                <span>*请输入正确的手机号</span>
            </label>
            <label for="" class="add_player_a">
                出生日期:
                <input type="date" name="time" id="time">
                <span>*出生日期不能为空</span>
            </label>
            <label for="" class="add_player_b">
                所在区域:(省/市)
                <select name="user.province"></select>
                (市)
                <select name="user.city"></select>
                (区/县)
                <select name="user.area"></select>
            </label>
            <label for="" class="add_player_b">
                毕业学校:(省/市)
                <select id="province1" name="province"></select>
                (市)
                <select id="city1" name="city"></select>
                (高&nbsp;校)
                <select id="school1" name="school"></select>
            </label>
            <div style="width: 216px; margin: 0;">
                <button type="button" class="layui-btn layui-btn-fluid" id="real_player">修改</button>
            </div>
        </form>
    </div>
</div>
</body>
<script type="text/javascript">
    new PCAS("user.province", "user.city", "user.area", "重庆市", "重庆市", "忠县");
</script>
<script>
    var user_id;
    $('#get_player').click(function () {
        var username = document.getElementById('username').value;
        var phone = document.getElementById('phone').value;
        var time = document.getElementById('time').value;
        /*获取所在区域*/
        var user_pre = document.getElementsByName('user.province')[0].value;
        var user_city = document.getElementsByName('user.city')[0].value;
        var user_area = document.getElementsByName('user.area')[0].value;
        var area = user_pre + '-' + user_city + '-' + user_area;
        /*获取毕业学校*/
        var u_pre = $("#province option:selected").text();
        var u_city = $("#city option:selected").text();
        var u_school = $("#school option:selected").text();
        var where = document.getElementById('where').value;
        var school = u_pre + '-' + u_city + '-' + u_school;
        if (username === '') {
            $('#username').next().css('visibility', 'visible')
        } else if (pattern.test(phone) === false) {
            $('#phone').next().css('visibility', 'visible')

        } else if (time === '') {
            $('#time').next().css('visibility', 'visible')
        } else {
            $.ajax({
                async: true,
                url: '/player/create_player/',
                type: 'post',
                headers: {"X-CSRFToken": $.cookie("csrftoken")},
                data: {
                    'username': username,
                    'phone': phone,
                    'time': time,
                    'area': area,
                    'school': school,
                    'where': where
                },
                success: function (success) {
                    layer.msg(success['msg'])
                },
                error: function (error) {
                    layer.msg(error['msg'])
                }
            });
        }
    });
    $(document).ready(function () {
        var $input = $('.context input');
        $input.focus(function () {
            var value = $(this).val();
            if (value === '') {
                $(this).next().css('visibility', 'visible');
            } else {
                $(this).next().css('visibility', 'hidden')
            }
        });
        $input.blur(function () {
            var value = $(this).val();
            if (value === '') {
                $(this).next().css('visibility', 'visible')
            } else {
                $(this).next().css('visibility', 'hidden')
            }
        });
        var pattern = /^1[34578]\d{9}$/;
        var $phone = $('#phone');
        $phone.focus(function () {
            var value = $(this).val();
            if (pattern.test(value)) {
                $(this).next().css('visibility', 'hidden')
            } else {
                $(this).next().css('visibility', 'visible')
            }
        });
        $phone.blur(function () {
            var value = $(this).val();
            if (pattern.test(value)) {
                $(this).next().css('visibility', 'hidden')
            } else {
                $(this).next().css('visibility', 'visible')
            }
        });
        $('#real_player').click(function () {
            var username = document.getElementById('username').value;
            var phone = document.getElementById('phone').value;
            var time = document.getElementById('time').value;
            var sex = document.getElementById('user_sex').value;
            /*获取所在区域*/
            var user_pre = document.getElementsByName('user.province')[0].value;
            var user_city = document.getElementsByName('user.city')[0].value;
            var user_area = document.getElementsByName('user.area')[0].value;
            var area = user_pre + '-' + user_city + '-' + user_area;
            /*获取毕业学校*/
            var u_pre = $("#province1 option:selected").text();
            var u_city = $("#city1 option:selected").text();
            var u_school = $("#school1 option:selected").text();
            var school = u_pre + '-' + u_city + '-' + u_school;
            if (username === '') {
                $('#username').next().css('visibility', 'visible')
            } else if (pattern.test(phone) === false) {
                $('#phone').next().css('visibility', 'visible')

            } else if (time === '') {
                $('#time').next().css('visibility', 'visible')
            } else {
                $.ajax({
                    async: true,
                    url: '/player/real_updateuser/',
                    type: 'post',
                    headers: {"X-CSRFToken": $.cookie("csrftoken")},
                    data: {
                        'username': username,
                        'phone': phone,
                        'time': time,
                        'area': area,
                        'school': school,
                        'userid': user_id,
                        'sex': sex,
                    },
                    success: function (success) {
                        if (success['msg'] === '成功') {
                            window.open('/player/showall/', target = '_self')
                        }
                    },
                    error: function (error) {
                        layer.msg(error['msg'])
                    }
                });
            }
        });
    });

    function renderForm() {
        layui.use('form', function () {
            var form = layui.form;
            form.render();
        });
    }

    $('#chong').click(function () {
        document.getElementById('p_name').value = '';
        document.getElementById('p_age').value = '';
        document.getElementById('p_sex').value = '';
        document.getElementById('p_status').value = '';
        document.getElementById('p_position').value = '';
        renderForm();
        get_playerdate()
    });
    layui.use('form', function () {
        var form = layui.form;
        form.on('select(all_team)', function () {
            get_date()
        });
        form.on('select(showall_player)', function () {
            get_playerdate()
        })
    });
    $('#showall_select').click(function () {
        get_date();
    });
    $('#player_select').click(function () {
        get_playerdate();
    });

    function get_playerdate() {
        var p_name = document.getElementById('p_name').value;
        var p_age = document.getElementById('p_age').value;
        var p_sex = document.getElementById('p_sex').value;
        var p_state = document.getElementById('p_status').value;
        var p_position = document.getElementById('p_position').value;
        var table = layui.table;
        table.reload('all_player', {
            where: {
                'p_name': p_name,
                'p_age': p_age,
                'p_sex': p_sex,
                'p_state': p_state,
                'p_position': p_position,
            },
            page: {
                curr: 1
            }
        }, 'data')
    }

    function get_date() {
        var name = document.getElementById('name').value;
        var age = document.getElementById('age').value;
        var sex = document.getElementById('sex').value;
        var role = document.getElementById('role').value;
        var table = layui.table;
        table.reload('team', {
            where: {
                'name': name,
                'age': age,
                'sex': sex,
                'role': role,
            },
            page: {
                curr: 1
            }
        }, 'data')
    }

    layui.use('element', function () {
        var $ = layui.jquery
            , element = layui.element;

    });
    layui.use('table', function () {
        var table = layui.table;
        var name = document.getElementById('name').value;
        var age = document.getElementById('age').value;
        var role = document.getElementById('role').value;
        var sex = document.getElementById('sex').value;
        table.render({
            elem: '#team'
            , url: '/player/show_all/'
            , toolbar: 'allDemo'
            , title: '用户数据表'
            , where: {
                'name': name,
                'age': age,
                'role': role,
                'sex': sex,
            }
            , defaultToolbar: ['filter', 'exports', 'print']
            , method: 'post'
            , cols: [[
                {field: 'userid', title: 'ID', width: 80, fixed: 'left'}
                , {
                    field: 'name', title: '姓名', width: 220, templet: function (data) {
                        return '<p><img style="height:20px;width:20px;border-radius:20px;margin-top:-3px;margin-right:3px" src=http://127.0.0.1:8000/static/' + data.userpic + '/>' + '<span>' + data.name + '</span></p>'
                    }
                }
                , {field: 'age', title: '年龄', width: 120}
                , {field: 'sex', title: '性别', width: 160}
                , {field: 'role', title: '角色', width: 160}
                , {field: 'palace', title: '住址',}
                , {field: 'school', title: '学校',}
                , {fixed: 'right', title: '操作', toolbar: '#allDemo', width: 150}
            ]]
            , page: true
        });
        table.on('tool(team)', function (obj) {
            user_id = obj.data.userid
            $('.update_user').css('display', 'block');
            $.ajax({
                async: true,
                url: '/player/select_myplayer/',
                type: 'post',
                headers: {"X-CSRFToken": $.cookie("csrftoken")},
                data: {
                    'userid': obj.data.userid
                },
                success: function (success) {
                    $('#username').val(success['data'][0].name);
                    $('#user_sex').val(success['data'][0].sex);
                    $('#phone').val(success['data'][0].phone);
                    $('#time').val(success['data'][0].data);
                    $('#pic').attr('src', "http://127.0.0.1:8000/static/" + success['data'][0].user_pic);
                },
                error: function (error) {
                    layer.msg(error['msg'])
                }
            })
        });
        var p_name = document.getElementById('p_name').value;
        var p_age = document.getElementById('p_age').value;
        var p_sex = document.getElementById('p_sex').value;
        var p_state = document.getElementById('p_status').value;
        var p_position = document.getElementById('p_position').value;
        table.render({
            elem: '#all_player'
            , url: '/player/show_player/'
            , toolbar: 'playerDemo'
            , where: {
                'p_name': p_name,
                'p_age': p_age,
                'p_sex': p_sex,
                'p_state': p_state,
                'p_position': p_position,
            }
            , title: '用户数据表'
            , defaultToolbar: ['filter', 'exports', 'print']
            , method: 'post'
            , cols: [[
                {field: 'userid', title: 'ID', width: 80, fixed: 'left'}
                , {
                    field: 'name', title: '姓名', width: 140, templet: function (data) {
                        return '<p><img style="height:20px;width:20px;border-radius:20px;margin-top:-3px;margin-right:3px" src=http://127.0.0.1:8000/static/' + data.userpic + '/>' + '<span>' + data.name + '</span></p>'
                    }
                }
                , {field: 'age', title: '年龄', width: 80}
                , {field: 'sex', title: '性别', width: 80}
                , {field: 'state', title: '状态', width: 80}
                , {field: 'palace', title: '住址',}
                , {field: 'school', title: '学校',}
                , {field: 'position', title: '位置',}
                , {field: 'specialty', title: '技术特点',}
                , {fixed: 'right', title: '操作', toolbar: '#playerDemo', width: 150}
            ]]
            , page: true
        });
        table.on('tool(all_player)', function (obj) {
            if (obj.event === 'del') {
                hsycms.confirm('confirm_sx', '确定要解约该球员吗',
                    function () {
                        $.ajax({
                            async: true,
                            url: '/player/del_player/',
                            type: 'post',
                            headers: {"X-CSRFToken": $.cookie("csrftoken")},
                            data: {
                                'userid': obj.data.userid
                            },
                            success: function (success) {
                                table.reload('all_player', {
                                    page: {
                                        curr: 1 //重新从第 1 页开始
                                    }
                                    , where: {
                                        url: '/player/show_player/'
                                    }
                                }, 'data');
                                layer.msg(success['msg'])
                            },
                            error: function (error) {
                                layer.msg(error['msg'])
                            }
                        })
                    },
                    function (res) {
                        layer.msg('取消操作')
                    },
                );
            } else {
                <!--这里是续约按钮 -->
            }
        })
    });
    layui.use('upload', function () {
        var $ = layui.jquery
            , upload = layui.upload;
        var uploadInst = upload.render({
            elem: '#test1'
            , url: '/player/update_pic/'
            , before: function (obj) {
                obj.preview(function (index, file, result) {
                    $('#pic').attr('src', result); //图片链接（base64）
                });
            }
            , done: function (res) {
                //如果上传失败
                if (res.code > 0) {
                    return layer.msg('上传失败');
                }
                //上传成功
            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function () {
                    uploadInst.upload();
                });
            }
        });
    })
</script>
</html>
